oathkeeper:
  accessRules:
    enabled: false
  managedAccessRules: false
  extraVolumeMounts: []
  extraVolumes: []
  
  config:
    
    serve:
      proxy:
        cors:
          enabled: true
          allowed_origins:
            - "https://geometrics.combaldieu.fr"
          allowed_methods:
            - POST
            - GET
            - PUT
            - PATCH
            - DELETE
          allowed_headers:
            - Authorization
            - Content-Type
          exposed_headers:
            - Content-Type
          allow_credentials: true
      api:
        cors:
          enabled: true

    authenticators:
      cookie_session:
        enabled: true
        config:
          check_session_url: http://kratos-public.geo-ory.svc.cluster.local:80/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          only:
            - ory_kratos_session

      noop:
        enabled: true

    authorizers:
      allow:
        enabled: true
      
      deny:
        enabled: true

      keto_engine_acp_ory:
        enabled: true
        config:
          base_url: http://keto-read.geo-ory.svc.cluster.local:4466
          required_action: "access"
          required_resource: "resources:{{.MatchContext.URL.Path}}"

    mutators:
      noop:
        enabled: true

      header:
        enabled: true
        config:
          headers:
            X-User: "{{ print .Subject }}"

    errors:
      fallback:
        - redirect
      handlers:
        json:
          enabled: true
          config:
            verbose: true
        redirect:
          enabled: true
          config:
            to: https://kratos.combaldieu.fr/self-service/login/browser?return_to={{ .MatchContext.URL.String }}

    log:
      level: debug
      format: text

# Enable Maester controller (runs as separate deployment)
maester:
  enabled: true
  mode: controller  # Options: controller or sidecar
  
  # ConfigMap name that Maester will create/update with rules
  configMap:
    name: oathkeeper-rules
  
  # Watch all namespaces for Rule CRDs (or set to specific namespace)
  watchNamespace: geo-ory
  configMapNamespace: geo-ory

service:
  proxy:
    enabled: true
    type: ClusterIP

  api:
    enabled: true
    type: ClusterIP